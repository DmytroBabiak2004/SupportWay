<article class="post-card">

  <header class="post-header">
    <div class="user-group" (click)="openProfile(post.authorUserName || post.userId)">
      <div class="avatar-container">
        <img *ngIf="post.authorPhotoBase64; else initialFallback"
             [src]="profileService.getAvatarSrc(post.authorPhotoBase64)"
             alt="avatar">
        <ng-template #initialFallback>
          <div class="initials">{{ getInitials(post.authorUserName || '?') }}</div>
        </ng-template>
      </div>

      <div class="meta-info">
        <span class="username">{{ post.authorUserName || 'Unknown' }}</span>
        <span class="date" [title]="post.createdAt | date:'medium'">
          {{ post.createdAt | relativeTime }}
        </span>
      </div>
    </div>
  </header>

  <div class="post-media" *ngIf="post.image" (dblclick)="toggleLike()">
    <div class="image-container">
      <img [src]="'data:image/jpeg;base64,' + post.image" [alt]="post.title || 'Post'">
    </div>
  </div>

  <div class="post-actions-bar">
    <div class="actions-left">
      <button class="action-btn like-btn" [class.active]="isLiked" (click)="toggleLike()">
        <svg viewBox="0 0 24 24"><path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0 3.072-2.652 4.956-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 0 1 4.708-5.218 4.21 4.21 0 0 1 3.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 0 1 3.679-1.938Z"></path></svg>
        <span class="count-label" *ngIf="likesCount > 0">{{ likesCount }}</span>
      </button>

      <button class="action-btn comment-btn" (click)="toggleComments()">
        <svg viewBox="0 0 24 24"><path d="M20.656 17.008a9.993 9.993 0 1 0-3.59 3.615L22 22Z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path></svg>
        <span class="count-label" *ngIf="commentsCount > 0">{{ commentsCount }}</span>
      </button>
    </div>
  </div>

  <div class="post-content">
    <div class="caption-block">
      <ng-container *ngIf="post.content">
        <span class="author-name-inline" (click)="openProfile(post.authorUserName)">
          {{ post.authorUserName }}
        </span>
        <span class="post-text">{{ post.content }}</span>
      </ng-container>
    </div>

    <div class="view-comments-link" *ngIf="!showComments && commentsCount > 0" (click)="toggleComments()">
      View all {{ commentsCount }} comments
    </div>
  </div>

  <div class="comments-section" *ngIf="showComments">
    <div *ngIf="isLoadingComments" class="loading-state">Updating...</div>

    <div *ngFor="let comment of comments" class="comment-item">

      <div class="c-avatar" (click)="openProfile(comment.userName || comment.userId)">
        <img *ngIf="comment.userPhotoBase64; else comInitials"
             [src]="profileService.getAvatarSrc(comment.userPhotoBase64)"
             alt="u">
        <ng-template #comInitials>
          <div class="initials">{{ getInitials(comment.userName || '?') }}</div>
        </ng-template>
      </div>

      <div class="c-body">
        <div class="c-header">
          <span class="c-user clickable-username" (click)="openProfile(comment.userName || comment.userId)">
            {{ comment.userName }}
          </span>
          <span class="c-date">{{ comment.createdAt | relativeTime }}</span>
        </div>
        <div class="c-text">{{ comment.text }}</div>
      </div>
    </div>

    <div class="comment-input-wrapper">
      <input type="text" placeholder="Add a comment..." [(ngModel)]="newCommentText" (keydown.enter)="newCommentText.trim() && sendComment()">
      <button class="post-link-btn" [disabled]="!newCommentText.trim()" (click)="sendComment()">Post</button>
    </div>
  </div>

</article>
