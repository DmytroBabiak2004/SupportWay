<div class="profile-page">
  <div class="loader-container" *ngIf="loading">
    <span class="spinner"></span>
  </div>

  <div class="profile-container" *ngIf="!loading && profile">
    <header class="profile-header">

      <div class="header-start">
        <div class="avatar-wrapper">
          <div class="avatar">
            <img *ngIf="profile.photoBase64; else fb" [src]="profileService.getAvatarSrc(profile.photoBase64)" alt="Avatar"/>
            <ng-template #fb><div class="avatar-fallback">{{ initials }}</div></ng-template>
          </div>

          <label *ngIf="isOwnProfile" class="btn-circle-upload" [class.loading]="uploadingPhoto">
            <input type="file" (change)="onPhotoSelected($event)" accept="image/*" [disabled]="uploadingPhoto" />
            <svg *ngIf="!uploadingPhoto" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
              <circle cx="12" cy="13" r="4"></circle>
            </svg>
            <span *ngIf="uploadingPhoto" class="mini-spinner"></span>
          </label>
        </div>
      </div>

      <div class="header-mid">
        <div class="name-row">
          <h1 class="username">
            {{ profile.name }} {{ profile.fullName }}
            <span *ngIf="!profile.name && !profile.fullName">{{ profile.username }}</span>
          </h1>
        </div>

        <div class="real-name" *ngIf="profile.name || profile.fullName">
          {{ profile.username }}
        </div>

        <div class="rating-section" [class.readonly]="isOwnProfile">
          <div class="stars-container">
    <span
      *ngFor="let star of [1, 2, 3, 4, 5]"
      class="star"
      [class.filled]="star <= (profile.rating || 0)"
      (click)="setRate(star)"
      [title]="isOwnProfile ? 'Ви не можете оцінити себе' : 'Оцінити на ' + star"
    >
      ★
    </span>
          </div>
          <span class="rating-numeric">{{ (profile.rating || 0) | number:'1.1-1' }}</span>
        </div>
        <div class="bio-block">
          <ng-container *ngIf="!isEditingDescription; else editBio">
            <p class="bio-text">{{ profile.description || 'Опис відсутній.' }}</p>

            <button *ngIf="isOwnProfile" class="btn-text-icon" (click)="startEditDescription()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
              <span>Редагувати</span>
            </button>
          </ng-container>

          <ng-template #editBio>
            <div class="bio-edit">
              <textarea [(ngModel)]="descriptionDraft" rows="3"></textarea>
              <div class="edit-btns">
                <button class="btn sm" (click)="cancelEditDescription()">Скасувати</button>
                <button class="btn primary sm" (click)="saveDescription()" [disabled]="savingDescription">Зберегти</button>
              </div>
            </div>
          </ng-template>
        </div>

        <div class="stranger-actions" *ngIf="!isOwnProfile">
          <button class="btn primary" [class.following]="isFollowing" (click)="toggleFollow()">
            {{ isFollowing ? 'Відписатися' : 'Підписатися' }}
          </button>
          <button class="btn" (click)="sendMessage()">Написати</button>
        </div>

        <div class="meta-row">
          <span>З нами з {{ profile.createdAt | date:'yyyy' }}</span>
        </div>
      </div>

      <div class="header-end">
        <div class="stats-row">
          <div class="stat"><div class="num">{{ profile.followersCount }}</div><div class="label">Followers</div></div>
          <div class="stat"><div class="num">{{ profile.followingCount }}</div><div class="label">Following</div></div>
        </div>

        <div class="own-actions" *ngIf="isOwnProfile">
          <button class="btn logout-btn" (click)="onLogout()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Вийти з акаунту</span>
          </button>
        </div>
      </div>

    </header>
  </div>
</div>
